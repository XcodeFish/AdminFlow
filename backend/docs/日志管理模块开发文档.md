# 日志管理模块开发文档

## 一、模块概述

### 1.1 模块说明

日志管理模块是AdminFlow的核心功能模块，主要负责系统操作日志和接口调用日志的记录、存储、查询和分析。该模块为系统提供完整的可追溯性，帮助管理员了解系统使用情况、排查问题、进行安全审计等。

### 1.2 主要功能

- **操作日志**：记录用户在前端后台管理系统中的所有操作，包括登录、登出、增删改查等操作
- **接口日志**：记录后端所有接口的调用情况，包括请求参数、响应结果、执行时间、状态码等信息
- **日志查询**：支持多条件查询、导出等功能
- **日志分析**：提供日志统计分析功能，如操作频率、错误率等指标

### 1.3 技术架构

- 后端：NestJS + TypeScript
- 日志拦截：使用NestJS拦截器和AOP技术
- 数据存储：优先使用数据库存储，可选择定期归档至文件
- 性能优化：采用异步写入方式，避免影响系统主流程性能

## 二、目录结构

```
src/
└── logger/                     # 日志管理模块根目录
    ├── logger.module.ts        # 日志模块入口
    ├── operation-log/          # 操作日志相关
    │   ├── operation-log.controller.ts
    │   ├── operation-log.service.ts
    │   ├── operation-log.entity.ts
    │   ├── operation-log.repository.ts
    │   ├── dto/                # 数据传输对象
    │   ├── decorators/         # 自定义装饰器
    │   └── interceptors/       # 操作日志拦截器
    ├── api-log/                # 接口日志相关
    │   ├── api-log.controller.ts
    │   ├── api-log.service.ts
    │   ├── api-log.entity.ts
    │   ├── api-log.repository.ts
    │   ├── dto/                # 数据传输对象
    │   ├── interceptors/       # 接口日志拦截器
    │   └── filters/            # 异常过滤器
    ├── common/                 # 公共组件
    │   ├── constants/          # 常量定义
    │   ├── enums/              # 枚举定义
    │   └── utils/              # 工具函数
    └── dashboard/              # 日志统计分析
        ├── dashboard.controller.ts
        └── dashboard.service.ts
```

## 三、开发规范

### 3.1 命名规范

- **文件命名**：采用kebab-case命名方式，如`operation-log.entity.ts`
- **类命名**：采用PascalCase命名方式，如`OperationLogEntity`
- **方法命名**：采用camelCase命名方式，如`getLogList()`
- **变量命名**：采用camelCase命名方式，如`logType`

### 3.2 接口路径规范

- API基础路径：`/api/v1/logger`
- 操作日志相关：`/api/v1/logger/operation`
- 接口日志相关：`/api/v1/logger/api`
- 日志统计分析：`/api/v1/logger/dashboard`

### 3.3 权限控制

- 日志查询需要`logger:view`权限
- 日志删除需要`logger:delete`权限
- 导出日志需要`logger:export`权限

## 四、实现要点

### 4.1 操作日志

1. **记录内容**：用户信息、操作类型、操作对象、操作内容、操作结果、IP地址、浏览器信息、操作时间等
2. **实现方式**：
   - 使用拦截器自动记录Controller层方法调用
   - 使用自定义注解标记需要记录的操作
   - 前端页面切换时通过API记录页面访问日志
3. **性能优化**：
   - 采用异步方式写入日志，避免影响主流程性能
   - 考虑批量写入机制，减少数据库压力
4. **安全考虑**：
   - 敏感信息脱敏（如密码不记录明文）
   - 必要时对日志内容进行加密

### 4.2 接口日志

1. **记录内容**：接口路径、请求方法、请求参数、响应结果、状态码、错误信息、执行时间、IP地址、用户信息等
2. **实现方式**：
   - 使用全局拦截器统一记录所有接口调用
   - 使用异常过滤器记录异常情况
3. **性能优化**：
   - 可配置是否记录请求体和响应体（对于大数据量接口）
   - 异步写入日志
4. **安全考虑**：
   - 对敏感信息进行脱敏
   - 根据需要选择性记录请求参数和响应结果

### 4.3 日志查询与分析

1. **查询功能**：
   - 支持多条件组合查询（时间范围、操作类型、用户等）
   - 支持导出查询结果为Excel
2. **统计分析**：
   - 操作类型分布统计
   - 用户活跃度分析
   - 接口调用频率统计
   - 错误率统计

## 五、前端集成

### 5.1 页面规划

- 操作日志页：查询和展示用户操作日志
- 接口日志页：查询和展示接口调用日志
- 日志分析页：展示日志统计图表

### 5.2 组件设计

- 日志列表组件：支持分页、排序、过滤
- 日志详情组件：展示日志详细信息
- 统计图表组件：使用ECharts展示统计数据

## 六、测试要点

### 6.1 单元测试

- 测试日志服务的核心功能
- 测试拦截器的日志记录逻辑

### 6.2 集成测试

- 测试日志模块与其他模块的集成
- 测试在高并发场景下的性能表现

### 6.3 功能测试

- 验证各类操作的日志记录是否准确
- 验证日志查询功能是否正常

## 七、部署与维护

### 7.1 部署注意事项

- 确保数据库有足够空间存储日志数据
- 配置合理的日志清理策略

### 7.2 运维建议

- 定期归档历史日志
- 监控日志数据增长速度
- 配置日志数据备份策略

## 八、扩展计划

### 8.1 未来功能

- 添加日志告警功能
- 支持日志数据可视化分析
- 支持更复杂的日志搜索语法

### 8.2 性能优化

- 考虑使用专业日志系统（如ELK栈）
- 针对大数据量场景优化查询性能
