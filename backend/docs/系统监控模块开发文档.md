# 系统监控模块开发文档

## 一、模块概述

### 1.1 模块说明

系统监控模块是AdminFlow的重要组成部分，主要负责对系统的各项指标进行实时监控和展示，包括服务器状态、缓存使用情况、在线用户等关键信息，为系统管理员提供全面的系统运行状况视图。

### 1.2 主要功能

- **服务器监控**：监控CPU、内存、磁盘、网络等服务器核心指标
- **缓存监控**：Redis缓存使用情况、缓存命中率、内存占用等指标监控
- **在线用户**：实时查看系统当前在线用户信息
- **定时任务**：监控系统定时任务的执行状态和历史记录
- **性能分析**：API调用性能、系统响应时间分析

### 1.3 技术架构

- 后端：NestJS + TypeScript
- 数据采集：node-os-utils、systeminformation
- 缓存监控：Redis客户端API
- 数据存储：采用时序数据库(可选InfluxDB)存储历史监控数据
- 可视化：ECharts + Element Plus

## 二、目录结构

```
src/
└── monitor/                 # 系统监控模块根目录
    ├── monitor.module.ts    # 监控模块入口
    ├── server/              # 服务器监控
    │   ├── server.controller.ts
    │   ├── server.service.ts
    │   ├── dto/             # 数据传输对象
    │   ├── entities/        # 实体定义
    │   └── interfaces/      # 接口定义
    ├── cache/               # 缓存监控
    │   ├── cache.controller.ts
    │   ├── cache.service.ts
    │   ├── dto/
    │   └── interfaces/
    ├── online/              # 在线用户监控
    │   ├── online.controller.ts
    │   ├── online.service.ts
    │   └── dto/
    ├── job/                 # 定时任务监控
    │   ├── job.controller.ts
    │   ├── job.service.ts
    │   └── dto/
    └── performance/         # 性能监控
        ├── performance.controller.ts
        ├── performance.service.ts
        ├── dto/
        └── interceptors/    # 性能监控拦截器
```

## 三、开发规范

### 3.1 命名规范

- **文件命名**：采用kebab-case命名方式，如`server-info.dto.ts`
- **类命名**：采用PascalCase命名方式，如`ServerInfoDto`
- **方法命名**：采用camelCase命名方式，如`getServerInfo()`
- **变量命名**：采用camelCase命名方式，如`cpuUsage`

### 3.2 接口路径规范

- API基础路径：`/api/v1/monitor`
- 服务器监控：`/api/v1/monitor/server`
- 缓存监控：`/api/v1/monitor/cache`
- 在线用户：`/api/v1/monitor/online`
- 定时任务：`/api/v1/monitor/job`
- 性能监控：`/api/v1/monitor/performance`

### 3.3 权限控制

- 监控模块的所有接口均需要`monitor:view`权限
- 管理操作（如清理缓存）需要`monitor:manage`权限

## 四、实现要点

### 4.1 服务器监控

1. **数据收集**：使用`node-os-utils`和`systeminformation`库收集服务器基础信息
2. **性能优化**：避免频繁收集数据导致服务器负载增加，建议设置合理的采集频率
3. **数据存储**：考虑使用时序数据库存储历史监控数据，方便展示趋势图

### 4.2 缓存监控

1. **连接管理**：使用连接池管理Redis连接，避免频繁创建销毁连接
2. **指标采集**：通过Redis的`INFO`命令获取完整的缓存状态信息
3. **数据展示**：重点关注内存使用率、键值数量、命中率等核心指标

### 4.3 在线用户监控

1. **会话管理**：通过用户会话记录用户登录状态
2. **实时更新**：使用WebSocket推送实时用户上下线通知
3. **强制下线**：支持管理员强制使特定用户下线的功能

### 4.4 定时任务监控

1. **任务追踪**：记录每个定时任务的执行状态、耗时、结果等信息
2. **告警机制**：当任务执行异常时，触发相应的告警通知

### 4.5 性能监控

1. **请求拦截**：通过NestJS拦截器记录请求执行时间
2. **关键指标**：重点关注API平均响应时间、慢查询分析等

## 五、前端集成

### 5.1 页面规划

- 概览页：展示所有监控模块的核心指标
- 服务器监控页：详细展示服务器各项指标
- 缓存监控页：展示Redis缓存状态
- 在线用户页：管理在线用户
- 任务监控页：展示定时任务执行情况
- 性能分析页：展示系统性能指标

### 5.2 图表组件

- 使用ECharts实现各种监控指标的图表展示
- 实现实时更新的仪表盘

### 5.3 交互设计

- 提供数据刷新间隔设置
- 支持图表数据导出功能
- 提供时间范围筛选功能

## 六、测试要点

### 6.1 单元测试

- 测试各监控服务的数据采集和处理逻辑
- 模拟不同的系统负载场景进行测试

### 6.2 集成测试

- 测试监控模块与其他模块的集成
- 测试数据采集与存储流程

### 6.3 性能测试

- 测试监控模块自身对系统性能的影响
- 确保在高负载下监控模块仍能正常工作

## 七、部署与维护

### 7.1 部署注意事项

- 确保有足够的存储空间用于历史监控数据
- 配置合理的数据采集频率和保留策略

### 7.2 运维建议

- 定期检查监控数据的准确性
- 设置适当的告警阈值，避免过多误报
- 定期清理历史监控数据，防止存储空间耗尽

## 八、扩展计划

### 8.1 未来功能

- 添加分布式系统监控支持
- 增强告警机制，支持邮件、短信等多种通知方式
- 实现自定义监控面板配置

### 8.2 集成第三方

- 考虑与Prometheus、Grafana等专业监控工具集成
- 提供导出数据到第三方分析工具的能力
